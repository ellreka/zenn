---
title: "Chromeæ‹¡å¼µã§ãƒšãƒ¼ã‚¸å†…ã®windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã—ã¦popupã‚„backgroundã«é€ä¿¡ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ¹"
type: "tech"
topics:
  - "chromeæ‹¡å¼µ"
published: true
published_at: "2022-06-17 01:53"
---

Chrome æ‹¡å¼µã‹ã‚‰ãƒšãƒ¼ã‚¸å†…ã® window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦è‰²ã€…ã‚„ã‚‹ã®ã«å°‘ã—è©°ã¾ã£ãŸã®ã§æ›¸ãã¾ã™ã€‚

# ãƒšãƒ¼ã‚¸å†…ã® window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã™ã‚‹

content_scripts ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ãƒšãƒ¼ã‚¸å†…ã® window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã¯åˆ¥ç‰©ã§ã™ã€‚
ãã®ãŸã‚ãƒšãƒ¼ã‚¸å†…ã® window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã¯ç›´æ¥ãƒšãƒ¼ã‚¸ã« js ã‚’åŸ‹ã‚è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```json:manifest.json
  "manifest_version": 3,
  "content_scripts": [
    {
      "matches": ["https://example.com/*"],
      "js": ["content_scripts.js"]
    }
  ],
  "web_accessible_resources": [
    {
      "resources": ["embed.js"],
      "matches": ["https://example.com/*"]
    }
  ]
```

`web_accessible_resources`ã«`embed.js`ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

```js:content_scripts.js
const head = document.head
const script = document.createElement('script')
script.src = chrome.runtime.getURL('content.js')
head.appendChild(script)
```

```js:embed.js
const func = () => {
  console.log(window)
}
func()
```

ã“ã“ã§ window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ“ä½œã§ãã¾ã™ã€‚

# window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æƒ…å ±ã‚’ popup ã‚„ background ã«é€ä¿¡ã™ã‚‹

åŸ‹ã‚è¾¼ã‚“ã  js å†…ã§ã¯`chrome.runtime.sendMessage`ãŒä½¿ãˆã¾ã›ã‚“ã€‚
ãã®ãŸã‚ä»–æ©Ÿèƒ½ã¨é€šä¿¡ã™ã‚‹ãŸã‚ã«`window.postMessage`ã§ä¸€åº¦ content_scripts ã‚’çµŒç”±ã—ã¾ã™ã€‚

æµã‚Œã¨ã—ã¦ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

![](https://gyazo.com/eb82a6a2460bca588ecbfbf45132b4d0.png)

å®Ÿè£…ä¾‹ã¨ã—ã¦ popup ã§ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰ window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã—ã¦ã¿ã¾ã™ã€‚

```tsx:popup.tsx
export const Popup = () => {
  const [state, setState] = useState()

  useEffect(() => {
    // content_scriptsã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Šã¾ã™
    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
      switch(request.action) {
        case 'GET_WINDOW':
	  setState(request.data)
	  break
      }
    }
  }, [])

  const getWindowObject = async () => {
    const tabId = await getTabId() // chrome.tabs.query()ã§tabIdã‚’å–å¾—
    if (tabId != null) {
      // content_scriptsã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
      chrome.tabs.sendMessage(tabId, { action: 'GET_WINDOW' })
    }
  }
  return <button onClick={getWindowObject}>btn</button>
}
```

```js:content_scripts.js
// popupã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Šã€embedã«é€ä¿¡ã—ã¾ã™
chrome.runtime.onMessage.addListener((request, sender) => {
  window.postMessage(
    { type: 'FROM_CONTENT', action: request.action, data: request.data },
    '*'
  )
})

// embedã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Šã€popupã«é€ä¿¡ã—ã¾ã™
window.addEventListener('message', () => {
  if (event.source != window) {
    return
  }
  if (event.data.type && event.data.type === 'FROM_EMBED') {
    switch (event.data.action) {
      case 'GET_WINDOW':
        chrome.runtime.sendMessage({
          action: event.data.action,
          data: event.data.data
        })
        break
    }
  }
}, false)
```

```js:embed.js
// content_scriptsã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Šã€windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã—ã¦é€ä¿¡ã—ã¾ã™
window.addEventListener('message', () => {
  if (event.source != window) {
    return
  }
  if (event.data.type && event.data.type === 'FROM_CONTENT') {
    switch (event.data.action) {
      case 'GET_WINDOW':
        const data = JSON.stringify(window)
        window.postMessage(
	{ type: 'FROM_EMBED', action: 'GET_WINDOW', data },
          '*'
        )
        break
    }
  }
}, false)
```

ã“ã‚Œã§ popup ã‚„ background ã‹ã‚‰ window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ“ä½œã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã¯ãšã§ã™ã€‚

# ã¾ã¨ã‚

èª¿ã¹ã¦ã‚‚ã‚ã¾ã‚Šå‡ºã¦ã“ãªã‹ã£ãŸã®ã§æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚
ã‚‚ã£ã¨è‰¯ã„æ–¹æ³•ãŒã‚ã‚Œã°æ•™ãˆã¦ä¸‹ã•ã„ mm
